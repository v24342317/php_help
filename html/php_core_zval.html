<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0054)http://blog.csdn.net/ohmygirl/article/details/41542445 -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css"></style>
 <meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" media="handheld" href="http://blog.csdn.net/ohmygirl/article/details/41542445#">

    <title>PHP内核探索之变量（1）变量的容器-Zval - 专注、专心
        - 博客频道 - CSDN.NET</title>
    

        <!--new top-->
        <link rel="stylesheet" href="http://static.csdn.net/public/common/toolbar/css/index.css">
        <!--new top-->

    <link rel="Stylesheet" type="text/css" href="./php_core_zval/style.css">
    <link id="RSSLink" title="RSS" type="application/rss+xml" rel="alternate" href="http://blog.csdn.net/ohmygirl/rss/list">
    <link rel="shortcut icon" href="http://c.csdnimg.cn/public/favicon.ico">
    <link type="text/css" rel="stylesheet" href="./php_core_zval/nobg.css">
 


<link rel="stylesheet" type="text/css" href="./php_core_zval/job_reco.css"><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><link href="./php_core_zval/bdsstyle.css" rel="stylesheet" type="text/css"><link rel="stylesheet" href="http://bdimg.share.baidu.com/static/api/css/share_style0_16.css?v=6aba13f0.css"></head>
<body class=" hPC" style=""><div id="MathJax_Message" style="display: none;"></div>
    
   


        <div id="body">
          <div id="main">
                <div class="main">
                        <div class="ad_class">
<div class="notice tracking-ad" data-mod="popu_3"> 

<a href="http://bbs.csdn.net/topics/391857175" target="_blank">
<font color="red">想听课？来发话题吧
</font></a>
&nbsp;&nbsp;&nbsp;

<a href="http://www.csdn.net/app/" target="_blank">
<font color="blue">CSDN APP 博客上线
</font></a>
&nbsp;&nbsp;&nbsp;
<a href="http://bbs.csdn.net/topics/391856835" target="_blank">
<font color="red">双11赚“双喜“，奖励多多
</font></a>
&nbsp;&nbsp;&nbsp;
<a href="http://blog.csdn.net/blogdevteam/article/details/49612641" target="_blank">
<font color="blue">有奖征文：云服务器使用初体验 
</font></a>
</div>                        </div>
                        
</div>
<!--AdForward End-->

  
<link href="./php_core_zval/comment1.css" type="text/css" rel="stylesheet">
<link href="./php_core_zval/style1.css" type="text/css" rel="stylesheet">

<link rel="stylesheet" href="http://static.blog.csdn.net/public/res-min/markdown_views.css?v=1.0">



<div id="article_details" class="details">
    <div class="article_title">   
         <span class="ico ico_type_Original"></span>


    <h1>
        <span class="link_title"><a href="./php_core_zval/PHP内核探索之变量（1）变量的容器-Zval - 专注、专心 - 博客频道 - CSDN.NET.htm">
        <font color="red">[置顶]</font>
        PHP内核探索之变量（1）变量的容器-Zval            
        </a></span>
    </h1>
</div>

   

    <div class="article_manage">
        <span class="link_categories">
        分类：
            <a href="http://blog.csdn.net/ohmygirl/article/category/1188651" onclick="_gaq.push([&#39;_trackEvent&#39;,&#39;function&#39;, &#39;onclick&#39;, &#39;blog_articles_fenlei&#39;]);">PHP</a> 
        </span>
    <span class="link_postdate">2014-11-27 10:21</span>
    <span class="link_view" title="阅读次数">1968人阅读</span>
    <span class="link_comments" title="评论次数"><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#comments" onclick="_gaq.push([&#39;_trackEvent&#39;,&#39;function&#39;, &#39;onclick&#39;, &#39;blog_articles_pinglun&#39;])">评论</a>(0)</span>
    <span class="link_collect"><a href="javascript:void(0);" onclick="javascript:collectArticle(&#39;PHP内核探索之变量（1）变量的容器-Zval&#39;,&#39;41542445&#39;);return false;" title="收藏">收藏</a></span>
    <span class="link_report"><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#report" onclick="javascript:report(41542445,2);return false;" title="举报">举报</a></span>
    
</div>

  

  
  
     

<div style="clear:both"></div><div style="border:solid 1px #ccc; background:#eee; float:left; min-width:200px;padding:4px 10px;"><p style="text-align:right;margin:0;"><span style="float:left;">目录<a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" title="系统根据文章中H1到H6标签自动生成文章目录">(?)</a></span><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" onclick="javascript:return openct(this);" title="展开">[+]</a></p><ol style="display:none;margin-left:14px;padding-left:14px;line-height:160%;"><li><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#t0">一Zval的基本结构</a></li><li><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#t1">二xdebug的安装配置</a></li><li><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#t2">Zval的更多原理</a></li><li><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#t3">使用unset时对减少相应zval的refcount值</a></li><li><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#t4">数组变量与普通变量生成的zval非常类似但也有很大不同</a></li><li><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#t5">引用的出现会令zval的规则变得复杂</a></li><li><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#t6">zval分离Copy on write和change on write</a></li><li><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#t7">本文参考文献</a></li></ol></div><div style="clear:both"></div><div id="article_content" class="article_content">

<p><span style="font-size:14px">作为数据的容器，我们常常需要跟变量打交道，不管这个变量是数字、数组、字符串、对象还是其他，因而可以说变量是构成语言的不可或缺的基础。本文是PHP内核探索之变量的第一篇，主要介绍zval的基本知识，包括如下几个方面的内容：</span></p>
<ol>
<li><strong><span style="font-size:14px">Zval的基本结构</span></strong></li><li><strong><span style="font-size:14px">查看zval的方法：debug_zval_dump和xdebug</span></strong></li><li><strong><span style="font-size:14px">Zval的原理，COW等</span></strong></li></ol>
<p><span style="font-size:14px">由于写作仓促，难免会有错误，欢迎指出。</span></p>
<h3><a name="t0"></a><span style="font-size:14px">一、Zval的基本结构</span></h3>
<p><span style="font-size:14px">Zval是PHP中最重要的数据结构之一（另一个比较重要的数据结构是hash table），它包含了PHP中的变量值和类型的相关信息。它是一个struct，基本结构为：</span></p>
<div class="cnblogs_code">
<pre><span style="color:#0000ff">struct</span><span style="color:#000000"> _zval_struct {
    zvalue_value value;     </span><span style="color:#008000">/*</span><span style="color:#008000"> value </span><span style="color:#008000">*/</span><span style="color:#000000">
    zend_uint refcount__gc;  </span><span style="color:#008000">/*</span><span style="color:#008000"> variable ref count </span><span style="color:#008000">*/</span><span style="color:#000000">
    zend_uchar type;          </span><span style="color:#008000">/*</span><span style="color:#008000"> active type </span><span style="color:#008000">*/</span><span style="color:#000000">
    zend_uchar is_ref__gc;    </span><span style="color:#008000">/*</span><span style="color:#008000"> if it is a ref variable </span><span style="color:#008000">*/</span><span style="color:#000000">
};
typedef </span><span style="color:#0000ff">struct</span> _zval_struct zval;</pre>
</div>
<p><span style="font-size:14px">其中：</span></p>
<p><strong><span style="font-size:14px">1.　　zval_value value</span></strong></p>
<p><span style="font-size:14px">变量的实际值，具体来说是一个zvalue_value的联合体（union）:</span></p>
<div class="cnblogs_code">
<pre><span style="color:#000000">typedef union _zvalue_value {
    </span><span style="color:#0000ff">long</span> lval;                  <span style="color:#008000">/*</span><span style="color:#008000"> long value </span><span style="color:#008000">*/</span>
    <span style="color:#0000ff">double</span> dval;                <span style="color:#008000">/*</span><span style="color:#008000"> double value </span><span style="color:#008000">*/</span>
    <span style="color:#0000ff">struct</span> {                    <span style="color:#008000">/*</span><span style="color:#008000"> string </span><span style="color:#008000">*/</span>
        <span style="color:#0000ff">char</span> *<span style="color:#000000">val;
        </span><span style="color:#0000ff">int</span><span style="color:#000000"> len;
    } str;
    HashTable </span>*ht;              <span style="color:#008000">/*</span><span style="color:#008000"> hash table value,used for array </span><span style="color:#008000">*/</span><span style="color:#000000">
    zend_object_value obj;      </span><span style="color:#008000">/*</span><span style="color:#008000"> object </span><span style="color:#008000">*/</span><span style="color:#000000">
} zvalue_value;</span></pre>
</div>
<p><strong><span style="font-size:14px">2.　　zend_uint refcount__gc&nbsp;&nbsp;</span></strong></p>
<p><span style="font-size:14px">该值实际上是一个计数器，用来保存有多少变量（或者符号，<span style="color:#0000ff">symbols</span>,所有的符号都存在符号表（symble table）中, 不同的作用域使用不同的符号表，关于这一点，我们之后会论述）指向该zval。在变量生成时，其refcount=1，典型的赋值操作如$a = $b会令zval的refcount加1，而unset操作会相应的减1。在PHP5.3之前，使用引用计数的机制来实现GC，如果一个zval的refcount较少到0，那么Zend引擎会认为没有任何变量指向该zval，因此会释放该zval所占的内存空间。但，事情有时并不会那么简单。后面我们会看到，单纯的引用计数机制无法GC掉循环引用的zval，即使指向该zval的变量已经被unset，从而导致了内存泄露（<span style="color:#0000ff">Memory
 Leak</span>）。</span></p>
<p><strong><span style="font-size:14px">3.　　zend_uchar type</span></strong></p>
<p><span style="font-size:14px">该字段用于表明变量的实际类型。在开始学习PHP的时候，我们已经知道，PHP中的变量包括<span style="color:#0000ff">四种标量类型</span>（bool,int,float,string），<span style="color:#0000ff">两种复合类型</span>（array, object）和<span style="color:#0000ff">两种特殊的类型</span>（resource 和NULL）。在zend内部，这些类型对应于下面的宏（代码位置
 phpsrc/Zend/zend.h）：</span></p>
<div class="cnblogs_code">
<pre><span style="color:#0000ff">#define</span> IS_NULL     0
<span style="color:#0000ff">#define</span> IS_LONG     1
<span style="color:#0000ff">#define</span> IS_DOUBLE   2
<span style="color:#0000ff">#define</span> IS_BOOL     3
<span style="color:#0000ff">#define</span> IS_ARRAY    4
<span style="color:#0000ff">#define</span> IS_OBJECT   5
<span style="color:#0000ff">#define</span> IS_STRING   6
<span style="color:#0000ff">#define</span> IS_RESOURCE 7
<span style="color:#0000ff">#define</span> IS_CONSTANT 8
<span style="color:#0000ff">#define</span> IS_CONSTANT_ARRAY   9
<span style="color:#0000ff">#define</span> IS_CALLABLE 10</pre>
</div>
<p><span style="font-size:14px"><strong>4.　　is_ref__gc</strong> </span></p>
<p><span style="font-size:14px">这个字段用于标记变量是否是引用变量。对于普通的变量，该值为0，而对于引用型的变量，该值为1。这个变量会影响zval的共享、分离等。关于这点，我们之后会有论述。</span></p>
<p><span style="font-size:14px">正如名字所示，ref_count__gc和<span style="color:#0000ff">is_ref__gc</span>是PHP的GC机制所需的很重要的两个字段，这两个字段的值，可以通过xdebug等调试工具查看。</span></p>
<h3><a name="t1"></a><span style="font-size:14px">二、xdebug的安装配置</span></h3>
<p><span style="font-size:14px">xdebug是一个开源的PHP 性能分析和debug工具。虽然对于一般的程序调试，<span style="color:#0000ff">var_dump</span>,<span style="color:#0000ff">echo</span>,<span style="color:#0000ff">print</span>,debug_backtrace等常见的调试工具已经基本够用，但对于一些复杂的调试和性能测试，xdebug绝对是一个很好的帮手（其他的如Xhprof等工具也很优秀）。</span></p>
<p><span style="font-size:14px">本文的基本环境：</span></p>
<p><span style="font-size:14px"><img src="./php_core_zval/252347120903191.png" alt=""></span></p>
<p><span style="font-size:14px"><img src="./php_core_zval/252347236213967.png" alt=""></span></p>
<p><span style="font-size:14px">安装xdebug的基本过程为(实际上是源码编译一个扩展)：</span></p>
<p><strong><span style="font-size:14px">1.　　下载源码包.</span></strong></p>
<p><span style="font-size:14px">　　下载地址为：<a target="_blank" href="http://www.xdebug.org/docs/install">http://www.xdebug.org/docs/install</a></span></p>
<p><span style="font-size:14px">　　本文中下载的版本为：xdebug-2.6.tar.gz</span></p>
<p><strong><span style="font-size:14px">2.　　解压</span></strong></p>
<div class="cnblogs_code">
<pre><span style="color:#0000ff">tar</span> xvzf xdebug-<span style="color:#800080">2.6</span>.<span style="color:#0000ff">tar</span>.gz</pre>
</div>
<p><strong><span style="font-size:14px">3.　　在xdebug的目录执行phpize</span></strong></p>
<p><strong><span style="font-size:14px">4.　　./configure&nbsp;&nbsp; 配置</span></strong></p>
<p><strong><span style="font-size:14px">5.　　Make&amp;&amp;&nbsp; make install</span></strong></p>
<p><span style="font-size:14px">这会生成xdebug.so扩展文件（zend_extension）,位置在xdebug/modules</span></p>
<p><strong><span style="font-size:14px">6.　　在php.ini中加载xdebug扩展</span></strong></p>
<div class="cnblogs_code">
<pre>zend_extension=your-xdebug-path/xdebug.so</pre>
</div>
<p><strong><span style="font-size:14px">7.　　添加xdebug的配置</span></strong></p>
<div class="cnblogs_code">
<pre>xdebug.profiler_enable =<span style="color:#000000"> on
xdebug.default_enable </span>=<span style="color:#000000"> on
xdebug.trace_output_dir</span>="/tmp/xdebug"<span style="color:#000000">
xdebug.trace_output_name </span>=<span style="color:#000000"> trace.%c.%p
xdebug.profiler_output_dir</span>="/tmp/xdebug"<span style="color:#000000">
xdebug.profiler_output_name</span>="cachegrind.out.%s"</pre>
</div>
<p><span style="font-size:14px">这里不再详细介绍各个配置项的含义，详细的请看：<a target="_blank" href="http://www.xdebug.org/docs/all">http://www.xdebug.org/docs/all</a>&nbsp;</span></p>
<p><span style="font-size:14px">现在，PHP中，应该已经有了Xdebug的扩展信息（php –m，也可以phpinfo()）：</span></p>
<p><span style="font-size:14px"><img src="./php_core_zval/252352589967475.png" alt="">&nbsp;<br>
</span></p>
<p><span style="font-size:14px">现在，你的脚本中，可以通过xdebug_debug_zval打印Zval的信息：</span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_410870" class="syntaxhighlighter  php"><div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command(&#39;CopyToClipboard&#39;,this);return false;">copy</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="About" title="?" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a><a href="https://code.csdn.net/snippets/534369" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="./php_core_zval/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;"></a><a href="https://code.csdn.net/snippets/534369/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="./php_core_zval/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;"></a><div style="position: absolute; left: 874px; top: 3357px; width: 29px; height: 14px; z-index: 99;"><embed id="ZeroClipboardMovie_1" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="29" height="14" name="ZeroClipboardMovie_1" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=1&amp;width=29&amp;height=14" wmode="transparent"></div></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$a</span><span>&nbsp;=&nbsp;</span><span class="keyword">array</span><span>(&nbsp;</span><span class="string">'test'</span><span>&nbsp;);&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$a</span><span>[]&nbsp;=&nbsp;&amp;</span><span class="vars">$a</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(&nbsp;<span class="string">'a'</span><span>&nbsp;);&nbsp;&nbsp;</span></span></li></ol></div><pre code_snippet_id="534369" snippet_file_name="blog_20150322_1_9733698" name="code" class="php" style="display: none;">$a = array( 'test' );
$a[] = &amp;$a;
xdebug_debug_zval( 'a' );</pre></div>
</div>
</div>
<h3><a name="t2"></a><span style="font-size:14px">3.　　Zval的更多原理</span></h3>
<p><span style="font-size:14px">（注，本部分主要参考：<a target="_blank" href="http://derickrethans.nl/collecting-garbage-phps-take-on-variables.html">http://derickrethans.nl/collecting-garbage-phps-take-on-variables.html</a>， 作者Derick Rethans是一位优秀的PHP内核专家，在全世界做过多次报告，都有相关的pdf下载，这里（<a target="_blank" href="http://derickrethans.nl/talks.html">http://derickrethans.nl/talks.html</a>
 ）有作者每次演讲的记录，很多都值得我们深入去学习研究）</span></p>
<p><span style="font-size:14px">前面我们已经说过，PHP使用Zval这种结构来保存变量，这里我们将继续追踪zval的更多细节。</span></p>
<p><span style="font-size:14px"><strong>1.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建变量时，会创建一个zval.</strong></span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_974188" class="syntaxhighlighter  php"><div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command(&#39;CopyToClipboard&#39;,this);return false;">copy</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="About" title="?" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a><a href="https://code.csdn.net/snippets/534369" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="./php_core_zval/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;"></a><a href="https://code.csdn.net/snippets/534369/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="./php_core_zval/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;"></a><div style="position: absolute; left: 874px; top: 3674px; width: 29px; height: 14px; z-index: 99;"><embed id="ZeroClipboardMovie_2" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="29" height="14" name="ZeroClipboardMovie_2" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=2&amp;width=29&amp;height=14" wmode="transparent"></div></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$str</span><span>&nbsp;=&nbsp;</span><span class="string">"test&nbsp;zval"</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span>xdebug_debug_zval(<span class="string">'str'</span><span>);&nbsp;&nbsp;</span></span></li></ol></div><pre code_snippet_id="534369" snippet_file_name="blog_20150322_2_5466786" name="code" class="php" style="display: none;">$str = "test zval";
xdebug_debug_zval('str');</pre></div>
</div>
</div>
<p><span style="font-size:14px">输出结果：</span></p>
<div class="cnblogs_code">
<pre>str: (refcount=1, is_ref=0)='test zval'</pre>
</div>
<p><span style="font-size:14px">当使用$str="test zval";来创建变量时，会在当前作用域的符号表中插入新的符号（str）,由于该变量是一个普通的变量，因此会生成一个<span style="color:#0000ff">refcount=1</span>且<span style="color:#0000ff">is_ref=0</span>的zval容器。也就是说，实际上是这样的:</span></p>
<p><span style="font-size:14px"><img src="./php_core_zval/252356036066910.png" alt=""></span></p>
<p><span style="font-size:14px"><strong>2.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 变量赋值给另外一个变量时，会增加zval的refcount值。</strong></span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_632002" class="syntaxhighlighter  php"><div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command(&#39;CopyToClipboard&#39;,this);return false;">copy</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="About" title="?" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a><a href="https://code.csdn.net/snippets/534369" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="./php_core_zval/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;"></a><a href="https://code.csdn.net/snippets/534369/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="./php_core_zval/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;"></a><div style="position: absolute; left: 874px; top: 4066px; width: 29px; height: 14px; z-index: 99;"><embed id="ZeroClipboardMovie_3" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="29" height="14" name="ZeroClipboardMovie_3" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=3&amp;width=29&amp;height=14" wmode="transparent"></div></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$str</span><span>&nbsp;&nbsp;=&nbsp;</span><span class="string">"test&nbsp;zval"</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$str2</span><span>&nbsp;=&nbsp;</span><span class="vars">$str</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'str'</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span>xdebug_debug_zval(<span class="string">'str2'</span><span>);&nbsp;&nbsp;</span></span></li></ol></div><pre code_snippet_id="534369" snippet_file_name="blog_20141127_3_2200357" name="code" class="php" style="display: none;">$str  = "test zval";
$str2 = $str;
xdebug_debug_zval('str');
xdebug_debug_zval('str2');</pre></div>
</div>
</div>
<p><span style="font-size:14px">输出结果： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>
</span></p>
<div class="cnblogs_code">
<pre>str: (refcount=2, is_ref=0)=<span style="color:#000000">'test zval'
str2: (refcount</span>=2, is_ref=0)='test zval'</pre>
</div>
<p><span style="font-size:14px">同时我们看到，str和是str2这两个symbol的zval结构是一样的。这里其实是PHP所做的一个优化，由于str和str2都是普通变量，因而它们指向了同一个zval，而没有为str2开辟单独的zval。这么做，可以在一定程度上节省内存。这时的str,str2与zval的对应关系是这样的：</span></p>
<p><span style="font-size:14px">&nbsp;<img src="./php_core_zval/252357198403053.png" alt=""></span></p>
<h3><a name="t3"></a><span style="font-size:14px"><strong>3.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 使用unset时，对减少相应zval的refcount值</strong></span></h3>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_398438" class="syntaxhighlighter  php"><div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command(&#39;CopyToClipboard&#39;,this);return false;">copy</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="About" title="?" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a><a href="https://code.csdn.net/snippets/534369" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="./php_core_zval/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;"></a><a href="https://code.csdn.net/snippets/534369/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="./php_core_zval/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;"></a><div style="position: absolute; left: 874px; top: 4606px; width: 29px; height: 14px; z-index: 99;"><embed id="ZeroClipboardMovie_4" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="29" height="14" name="ZeroClipboardMovie_4" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=4&amp;width=29&amp;height=14" wmode="transparent"></div></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$str</span><span>&nbsp;&nbsp;=&nbsp;</span><span class="string">"test&nbsp;zval"</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$str3</span><span>&nbsp;=&nbsp;</span><span class="vars">$str2</span><span>&nbsp;=&nbsp;</span><span class="vars">$str</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'str'</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span>unset(<span class="vars">$str2</span><span>,</span><span class="vars">$str3</span><span>)&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'str'</span><span>);&nbsp;&nbsp;</span></span></li></ol></div><pre code_snippet_id="534369" snippet_file_name="blog_20141127_4_6401229" name="code" class="php" style="display: none;">$str  = "test zval";
$str3 = $str2 = $str;
xdebug_debug_zval('str');
unset($str2,$str3)
xdebug_debug_zval('str');</pre></div>
</div>
</div>
<p><span style="font-size:14px">结果为：</span></p>
<div class="cnblogs_code">
<pre>str: (refcount=3, is_ref=0)=<span style="color:#000000">'test zval'
str: (refcount</span>=1, is_ref=0)='test zval'</pre>
</div>
<p><span style="font-size:14px">由于unset($str2,$str3)会将str2和str3从符号表中删除，因此，在unset之后，只有str指向该zval，如下图所示：</span></p>
<p><span style="font-size:14px">&nbsp;<img src="./php_core_zval/252358485127530.png" alt="" style="width:971px"></span></p>
<p><span style="font-size:14px">现在如果执行unset($str)，则由于zval的refcount会减少到0，该zval会从内存中清理。这当然是最理想的情况。</span></p>
<p><span style="font-size:14px">但是事情并不总是那么乐观。</span></p>
<h3><a name="t4"></a><span style="font-size:14px"><strong>4.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 数组变量与普通变量生成的zval非常类似，但也有很大不同</strong></span></h3>
<p><span style="font-size:14px">与标量这些普通变量不同，数组和对象这类复合型的变量在生成zval时，会为每个item项生成一个zval容器。例如：</span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_421047" class="syntaxhighlighter  php">
<table border="0" cellpadding="0" cellspacing="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
</td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="php variable">$ar</code> <code class="php plain">
= </code><code class="php keyword">array</code><code class="php plain">(</code></div>
<div class="line number2 index1 alt1"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'id'</code>&nbsp;&nbsp;<code class="php plain">=&gt; 38,</code></div>
<div class="line number3 index2 alt2"><code class="php spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="php string">'name'</code><code class="php plain">=&gt;
</code><code class="php string">'shine'</code></div>
<div class="line number4 index3 alt1"><code class="php plain">); &lt;br&gt;&lt;span style=</code><code class="php string">"font-size: 14px;"</code><code class="php plain">&gt;xdebug_debug_zval(</code><code class="php string">'ar'</code><code class="php plain">);&lt;/span&gt;</code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><span style="font-size:14px">打印出zval的结构是：</span></p>
<div class="cnblogs_code">
<pre>ar: (refcount=1, is_ref=0)=<span style="color:#000000">array (
    'id' </span>=&gt; (refcount=1, is_ref=0)=38,<span style="color:#000000"> 
    'name' </span>=&gt; (refcount=1, is_ref=0)=<span style="color:#000000">'shine'
)</span></pre>
</div>
<p><span style="font-size:14px">如下图所示：</span></p>
<p><span style="font-size:14px">&nbsp;<img src="./php_core_zval/260000276683970.png" alt=""></span></p>
<p><span style="font-size:14px">可以看出，变量$ar生成的过程中，共生成了<span style="color:#0000ff">3个zval容器</span>（红色部分标注）。对于每个zval而言，refcount的增减规则与普通变量的相同。例如，我们在数组中添加另外一个元素，并把$ar['name']的值赋给它：</span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_583485" class="syntaxhighlighter  php"><div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command(&#39;CopyToClipboard&#39;,this);return false;">copy</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="About" title="?" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a><a href="https://code.csdn.net/snippets/534369" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="./php_core_zval/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;"></a><a href="https://code.csdn.net/snippets/534369/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="./php_core_zval/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;"></a><div style="position: absolute; left: 874px; top: 6082px; width: 29px; height: 14px; z-index: 99;"><embed id="ZeroClipboardMovie_5" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="29" height="14" name="ZeroClipboardMovie_5" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=5&amp;width=29&amp;height=14" wmode="transparent"></div></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$ar</span><span>&nbsp;=&nbsp;</span><span class="keyword">array</span><span>(&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">'id'</span><span>&nbsp;&nbsp;&nbsp;=&gt;&nbsp;38,&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">'name'</span><span>&nbsp;=&gt;&nbsp;</span><span class="string">'shine'</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>);&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;</span></li><li class=""><span><span class="vars">$ar</span><span>[</span><span class="string">'test'</span><span>]&nbsp;=&nbsp;</span><span class="vars">$ar</span><span>[</span><span class="string">'name'</span><span>];&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'ar'</span><span>);&nbsp;&nbsp;</span></span></li></ol></div><pre code_snippet_id="534369" snippet_file_name="blog_20141127_5_6009920" name="code" class="php" style="display: none;">$ar = array(
    'id'   =&gt; 38,
    'name' =&gt; 'shine'
);
 
$ar['test'] = $ar['name'];
xdebug_debug_zval('ar');</pre></div>
</div>
</div>
<p><span style="font-size:14px">则打印出的zval为：</span></p>
<div class="cnblogs_code">
<pre>ar: (refcount=1, is_ref=0)=<span style="color:#000000">array (
    'id' </span>=&gt; (refcount=1, is_ref=0)=38,<span style="color:#000000">
    'name' </span>=&gt; (refcount=2, is_ref=0)='shine',<span style="color:#000000">
    'test' </span>=&gt; (refcount=2, is_ref=0)=<span style="color:#000000">'shine'
)</span></pre>
</div>
<p><span style="font-size:14px">如同普通变量一样，这时候,name和test这两个symbol指向同一个zval:</span></p>
<p><span style="font-size:14px">&nbsp;<img src="./php_core_zval/260002085747311.png" alt=""></span></p>
<p><span style="font-size:14px">同样的，从数组中移除元素时，会从符号表中删除相应的符号，同时减少对应zval的refcount值。同样，如果zval的refcount值减少到0，那么就会从内存中删除该zval：</span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_133558" class="syntaxhighlighter  php"><div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command(&#39;CopyToClipboard&#39;,this);return false;">copy</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="About" title="?" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a><a href="https://code.csdn.net/snippets/534369" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="./php_core_zval/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;"></a><a href="https://code.csdn.net/snippets/534369/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="./php_core_zval/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;"></a><div style="position: absolute; left: 874px; top: 6899px; width: 29px; height: 14px; z-index: 99;"><embed id="ZeroClipboardMovie_6" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="29" height="14" name="ZeroClipboardMovie_6" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=6&amp;width=29&amp;height=14" wmode="transparent"></div></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$ar</span><span>&nbsp;=&nbsp;</span><span class="keyword">array</span><span>(&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">'id'</span><span>&nbsp;&nbsp;&nbsp;=&gt;&nbsp;38,&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">'name'</span><span>&nbsp;=&gt;&nbsp;</span><span class="string">'shine'</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>);&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;</span></li><li class=""><span><span class="vars">$ar</span><span>[</span><span class="string">'test'</span><span>]&nbsp;=&nbsp;</span><span class="vars">$ar</span><span>[</span><span class="string">'name'</span><span>];&nbsp;&nbsp;</span></span></li><li class="alt"><span>unset(<span class="vars">$ar</span><span>[</span><span class="string">'test'</span><span>],</span><span class="vars">$ar</span><span>[</span><span class="string">'name'</span><span>]);&nbsp;&nbsp;</span></span></li><li class=""><span>xdebug_debug_zval(<span class="string">'ar'</span><span>);&nbsp;&nbsp;</span></span></li></ol></div><pre code_snippet_id="534369" snippet_file_name="blog_20141127_6_2370384" name="code" class="php" style="display: none;">$ar = array(
    'id'   =&gt; 38,
    'name' =&gt; 'shine'
);
 
$ar['test'] = $ar['name'];
unset($ar['test'],$ar['name']);
xdebug_debug_zval('ar');</pre></div>
</div>
</div>
<p><span style="font-size:14px">输出结果为：</span></p>
<div class="cnblogs_code">
<pre>ar: (refcount=1, is_ref=0)=array ('id' =&gt; (refcount=1, is_ref=0)=38)</pre>
</div>
<p><img src="./php_core_zval/260004147466629.png" alt=""></p>
<h3><a name="t5"></a><span style="font-size:14px"><strong>5.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 引用的出现，会令zval的规则变得复杂</strong></span></h3>
<p><span style="font-size:14px">在加入引用之后，情况会变的稍微复杂一点。例如，在数组中添加对本身的引用：</span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_123705" class="syntaxhighlighter  php"><div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command(&#39;CopyToClipboard&#39;,this);return false;">copy</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="About" title="?" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a><a href="https://code.csdn.net/snippets/534369" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="./php_core_zval/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;"></a><a href="https://code.csdn.net/snippets/534369/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="./php_core_zval/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;"></a><div style="position: absolute; left: 874px; top: 7518px; width: 29px; height: 14px; z-index: 99;"><embed id="ZeroClipboardMovie_7" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="29" height="14" name="ZeroClipboardMovie_7" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=7&amp;width=29&amp;height=14" wmode="transparent"></div></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$a</span><span>&nbsp;=&nbsp;</span><span class="vars">$array</span><span>(</span><span class="string">'one'</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$a</span><span>[]&nbsp;=&nbsp;&amp;</span><span class="vars">$a</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'a'</span><span>);&nbsp;&nbsp;</span></span></li></ol></div><pre code_snippet_id="534369" snippet_file_name="blog_20141127_7_4454310" name="code" class="php" style="display: none;">$a = $array('one');
$a[] = &amp;$a;
xdebug_debug_zval('a');</pre></div>
</div>
</div>
<p><span style="font-size:14px">输出的结果：</span></p>
<div class="cnblogs_code">
<pre>a: (refcount=2, is_ref=1)=<span style="color:#000000">array (
    </span>0 =&gt; (refcount=1, is_ref=0)='one', 
    1 =&gt; (refcount=2, is_ref=1)=<span style="color:#000000">...
)</span></pre>
</div>
<p><span style="font-size:14px">上述输出中，…表示指向原始数组，因而这是一个循环的引用。如下图所示：</span></p>
<p><span style="font-size:14px">&nbsp;<img src="./php_core_zval/260005110902417.png" alt=""></span></p>
<p><span style="font-size:14px">现在，我们对$a执行unset操作，这会在symbol table中删除相应的symbol,同时，zval的refcount减1（之前为2），也就是说，现在的zval应该是这样的结构：</span></p>
<div class="cnblogs_code">
<pre>(refcount=1, is_ref=1)=<span style="color:#000000">array (
    </span>0 =&gt; (refcount=1, is_ref=0)='one', 
    1 =&gt; (refcount=1, is_ref=1)=<span style="color:#000000">...
)</span></pre>
</div>
<p><span style="font-size:14px">也就是下图所示的结构：</span></p>
<p><span style="font-size:14px">&nbsp;<img src="./php_core_zval/260006093404888.png" alt=""></span></p>
<p><span style="font-size:14px">　　这时，不幸的事情发生了！</span></p>
<p><span style="font-size:14px">　　Unset之后，虽然没有变量指向该zval，但是该zval却不能被GC（指PHP5.3之前的单纯引用计数机制的GC）清理掉，因为zval的refcount均大于0。这样，这些zval实际上会一直存在内存中，直到请求结束（参考SAPI的生命周期）。在此之前，这些zval占据的内存不能被使用，便白白浪费了，换句话说，无法释放的内存导致了内存泄露。</span></p>
<p><span style="font-size:14px">　　如果这种内存泄露仅仅发生了一次或者少数几次，倒也还好，但如果是成千上万次的内存泄露，便是很大的问题了。尤其在长时间运行的脚本中（例如守护程序，一直在后台执行不会中断），由于无法回收内存，最终会导致系统“再无内存可用”。</span></p>
<h3><a name="t6"></a><span style="font-size:14px"><strong>6.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zval分离（Copy on write和change on write）</strong></span></h3>
<p><span style="font-size:14px">前面我们已经介绍过，在变量赋值的过程中例如$b = $a，为了节省空间,并不会为$a和$b都开辟单独的zval，而是使用共享zval的形式：</span></p>
<p><span style="font-size:14px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <img src="./php_core_zval/260007077779302.png" alt=""></span></p>
<p><span style="font-size:14px">那么问题来了：如果其中一个变量发生变化时，如何处理zval的共享问题？</span></p>
<p><span style="font-size:14px">对于这样的代码：</span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_678539" class="syntaxhighlighter  php"><div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command(&#39;CopyToClipboard&#39;,this);return false;">copy</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="About" title="?" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a><a href="https://code.csdn.net/snippets/534369" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="./php_core_zval/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;"></a><a href="https://code.csdn.net/snippets/534369/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="./php_core_zval/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;"></a><div style="position: absolute; left: 874px; top: 9089px; width: 29px; height: 14px; z-index: 99;"><embed id="ZeroClipboardMovie_8" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="29" height="14" name="ZeroClipboardMovie_8" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=8&amp;width=29&amp;height=14" wmode="transparent"></div></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$a</span><span>&nbsp;=&nbsp;</span><span class="string">"a&nbsp;simple&nbsp;test"</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$b</span><span>&nbsp;=&nbsp;</span><span class="vars">$a</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;</span></li><li class=""><span><span class="func">echo</span><span>&nbsp;</span><span class="string">"before&nbsp;write:"</span><span>.PHP_EOL;&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'a'</span><span>);&nbsp;&nbsp;</span></span></li><li class=""><span>xdebug_debug_zval(<span class="string">'b'</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;</span></li><li class=""><span><span class="vars">$b</span><span>&nbsp;=&nbsp;</span><span class="string">"thss"</span><span>;&nbsp;&nbsp;</span></span></li><li class="alt"><span><span class="func">echo</span><span>&nbsp;</span><span class="string">"after&nbsp;write:"</span><span>.PHP_EOL;&nbsp;&nbsp;</span></span></li><li class=""><span>xdebug_debug_zval(<span class="string">'a'</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'b'</span><span>);&nbsp;&nbsp;</span></span></li></ol></div><pre code_snippet_id="534369" snippet_file_name="blog_20141127_8_2144174" name="code" class="php" style="display: none;">$a = "a simple test";
$b = $a;
 
echo "before write:".PHP_EOL;
xdebug_debug_zval('a');
xdebug_debug_zval('b');
 
$b = "thss";
echo "after write:".PHP_EOL;
xdebug_debug_zval('a');
xdebug_debug_zval('b');</pre></div>
</div>
</div>
<p><span style="font-size:14px">打印的结果是：</span></p>
<div class="cnblogs_code">
<pre><span style="color:#000000">before write:
a: (refcount</span>=2, is_ref=0)=<span style="color:#000000">'a simple test'
b: (refcount</span>=2, is_ref=0)=<span style="color:#000000">'a simple test'
after write:
a: (refcount</span>=1, is_ref=0)=<span style="color:#000000">'a simple test'
b: (refcount</span>=1, is_ref=0)='thss'</pre>
</div>
<p><span style="font-size:14px">起初，符号表中a和b指向了同一个zval(这么做的原因是节省内存)，而后$b发生了变化，Zend会检查b指向的zval的refcount是否为1，如果是1，那么说明只有一个符号指向该zval，则直接更改zval。否则，说明这是一个共享的zval，需要将该zval分离出去，以保证单独变化互不影响，这种机制叫做<span style="color:#0000ff"><strong>COW</strong></span> –<span style="color:#0000ff">Copy
 on write</span>。在很多场景下，COW都是一种比较高效的策略。</span></p>
<p><span style="font-size:14px">那么对于引用变量呢？</span></p>
<div class="cnblogs_Highlighter sh-gutter">
<div>
<div id="highlighter_773766" class="syntaxhighlighter  php"><div class="dp-highlighter bg_php"><div class="bar"><div class="tools"><b>[php]</b> <a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="ViewSource" title="view plain" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="CopyToClipboard" title="copy" onclick="dp.sh.Toolbar.Command(&#39;CopyToClipboard&#39;,this);return false;">copy</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="PrintSource" title="print" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://blog.csdn.net/ohmygirl/article/details/41542445#" class="About" title="?" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a><a href="https://code.csdn.net/snippets/534369" target="_blank" title="在CODE上查看代码片" style="text-indent:0;"><img src="./php_core_zval/CODE_ico.png" width="12" height="12" alt="在CODE上查看代码片" style="position:relative;top:1px;left:2px;"></a><a href="https://code.csdn.net/snippets/534369/fork" target="_blank" title="派生到我的代码片" style="text-indent:0;"><img src="./php_core_zval/ico_fork.svg" width="12" height="12" alt="派生到我的代码片" style="position:relative;top:2px;left:2px;"></a><div style="position: absolute; left: 874px; top: 9706px; width: 29px; height: 14px; z-index: 99;"><embed id="ZeroClipboardMovie_9" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="29" height="14" name="ZeroClipboardMovie_9" align="middle" allowscriptaccess="always" allowfullscreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="id=9&amp;width=29&amp;height=14" wmode="transparent"></div></div></div><ol start="1" class="dp-c"><li class="alt"><span><span class="vars">$a</span><span>&nbsp;=&nbsp;</span><span class="string">'test'</span><span>;&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$b</span><span>&nbsp;=&nbsp;&amp;</span><span class="vars">$a</span><span>;&lt;br&gt;&nbsp;&nbsp;</span></span></li><li class="alt"><span><span class="func">echo</span><span>&nbsp;</span><span class="string">"before&nbsp;change:"</span><span>.PHP_EOL;&nbsp;&nbsp;</span></span></li><li class=""><span>xdebug_debug_zval(<span class="string">'a'</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'b'</span><span>);&lt;br&gt;&nbsp;&nbsp;</span></span></li><li class=""><span><span class="vars">$b</span><span>&nbsp;=&nbsp;12;&nbsp;&nbsp;</span></span></li><li class="alt"><span><span class="func">echo</span><span>&nbsp;</span><span class="string">"after&nbsp;change:"</span><span>.PHP_EOL;&nbsp;&nbsp;</span></span></li><li class=""><span>xdebug_debug_zval(<span class="string">'a'</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'b'</span><span>);&lt;br&gt;&nbsp;&nbsp;</span></span></li><li class=""><span>unset(<span class="vars">$b</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span><span class="func">echo</span><span>&nbsp;</span><span class="string">"after&nbsp;unset:"</span><span>.PHP_EOL;&nbsp;&nbsp;</span></span></li><li class=""><span>xdebug_debug_zval(<span class="string">'a'</span><span>);&nbsp;&nbsp;</span></span></li><li class="alt"><span>xdebug_debug_zval(<span class="string">'b'</span><span>);&nbsp;&nbsp;</span></span></li></ol></div><pre code_snippet_id="534369" snippet_file_name="blog_20141127_9_3912455" name="code" class="php" style="display: none;">$a = 'test';
$b = &amp;$a;&lt;br&gt;
echo "before change:".PHP_EOL;
xdebug_debug_zval('a');
xdebug_debug_zval('b');&lt;br&gt;
$b = 12;
echo "after change:".PHP_EOL;
xdebug_debug_zval('a');
xdebug_debug_zval('b');&lt;br&gt;
unset($b);
echo "after unset:".PHP_EOL;
xdebug_debug_zval('a');
xdebug_debug_zval('b');</pre></div>
</div>
</div>
<p><span style="font-size:14px">输出的结果为：</span></p>
<div class="cnblogs_code">
<pre><span style="color:#000000">before change:
a: (refcount</span>=2, is_ref=1)=<span style="color:#000000">'test'
b: (refcount</span>=2, is_ref=1)=<span style="color:#000000">'test'

after change:
a: (refcount</span>=2, is_ref=1)=12<span style="color:#000000">
b: (refcount</span>=2, is_ref=1)=12<span style="color:#000000">

after unset:
a: (refcount</span>=1, is_ref=0)=12</pre>
</div>
<p><span style="font-size:14px">可以看出，在改变了$b的值之后，Zend会检查zval的is_ref检查是否是引用变量，如果是引用变量，则直接更改即可，否则，需要执行刚刚提到的zval分离。由于$a 和 $b是引用变量，因而更改共享的zval实际上也间接更改了$a的值。而在unset($b)之后，变量$b从符号表中删除了。</span></p>
<p><span style="font-size:14px">这里也说明一个问题，unset并不是清除zval，而只是从符号表中删除相应的symbol。这样一来，之前很多的关于引用的疑问也可以理解了（下一节我们将深入探索PHP的引用）。</span></p>
<h3><a name="t7"></a><span style="font-size:14px">本文参考文献：</span></h3>
<ol>
<li><span style="font-size:14px">鸟哥的深入变量引用/分离&nbsp; <a target="_blank" href="http://www.laruence.com/2008/09/19/520.html">
http://www.laruence.com/2008/09/19/520.html</a></span></li><li><span style="font-size:14px">本文的主要参考文献&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a target="_blank" href="http://derickrethans.nl/collecting-garbage-phps-take-on-variables.html">
http://derickrethans.nl/collecting-garbage-phps-take-on-variables.html</a></span></li><li><span style="font-size:14px"><a target="_blank" href="http://blog.csdn.net/phpkernel/article/details/5732784">http://blog.csdn.net/phpkernel/article/details/5732784</a></span></li><li><span style="font-size:14px"><a target="_blank" href="http://www.jb51.net/article/50080.htm">http://www.jb51.net/article/50080.htm</a></span></li><li><span style="font-size:14px"><a target="_blank" href="http://www.nowamagic.net/librarys/veda/detail/1442">http://www.nowamagic.net/librarys/veda/detail/1442</a></span></li></ol>
   
</div>




   <link rel="stylesheet" href="http://static.blog.csdn.net/css/blog_detail.css">

</div>



<style>
.blog-ass-articl dd {
color: #369;
width: 99%; /*修改行*/
float: left;
overflow: hidden;
font: normal normal 12px/23px "SimSun";
height: 23px;
margin: 0;
padding: 0 0 0 10px;
margin-right: 30px;
background: url(http://static.blog.csdn.net/skin/default/images/blog-dot-red3.gif) no-repeat 0 10px;
}
</style>
<dl class="blog-ass-articl" id="res-relatived"> 
     <dt>&nbsp;</dt>
</dl>









    <div class="announce">
        * 以上用户言论只代表其个人观点，不代表CSDN网站的观点或立场<a name="reply"></a><a name="quote"></a></div>
</div>


    <div id="ad_bot">
    </div>
<div id="report_dialog">
</div>

<div id="d-top" style="bottom:60px;">
        <a id="quick-reply" class="btn btn-top q-reply" title="快速回复" style="display:none;">
            <img src="./php_core_zval/blog-icon-reply.png" alt="快速回复">
        </a>    

    <a id="d-top-a" class="btn btn-top backtop" style="display: none;" title="返回顶部" onclick="_gaq.push([&#39;_trackEvent&#39;,&#39;function&#39;, &#39;onclick&#39;, &#39;blog_articles_huidaodingbu&#39;])">         
         <img src="./php_core_zval/top.png" alt="TOP">
    </a>
</div>

<style type="text/css">
    .tag_list
    {
        background: none repeat scroll 0 0 #FFFFFF;
        border: 1px solid #D7CBC1;
        color: #000000;
        font-size: 12px;
        line-height: 20px;
        list-style: none outside none;
        margin: 10px 2% 0 1%;
        padding: 1px;
    }
    .tag_list h5
    {
        background: none repeat scroll 0 0 #E0DBD3;
        color: #47381C;
        font-size: 12px;
        height: 24px;
        line-height: 24px;
        padding: 0 5px;
        margin: 0;
    }
    .tag_list h5 a
    {
        color: #47381C;
    }
    .classify
    {
        margin: 10px 0;
        padding: 4px 12px 8px;
    }
    .classify a
    {
        margin-right: 20px;
        white-space: nowrap;
    }
</style>




</div>



<div id="pop_win" style="display:none ;position: absolute; z-index: 10000; border: 1px solid rgb(220, 220, 220); top: 222.5px; left: 630px; opacity: 1; background: none 0px 0px repeat scroll rgb(255, 255, 255);">
    
</div>
<div id="popup_mask"></div>
<style>
    #popup_mask
    {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 9999;
        left: 0px;
        top: 0px;
        opacity: 0.3;
        filter: alpha(opacity=30);
        display: none;
    }

</style>





                        <div class="clear">
                        </div>
              </div>                   
                
            </div>
            <div class="clear">
            </div>
        </div>
        












    </div>

   
    <link href="./php_core_zval/ask_float_block.css" type="text/css" rel="stylesheet">

 <div id="tag-suggest-pop">
  <div class="relative">
    <div class="close"></div>
    <div class="content"></div>
  </div>
</div><link rel="stylesheet" type="text/css" media="screen" href="./php_core_zval/ask_float_fonts_css-6b30a53970eb5c3a2a045e3df585b475.css"></body></html>